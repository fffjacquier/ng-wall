var ngMap=angular.module("ngMap",[]);ngMap.directive("infoWindow",["Attr2Options",function(Attr2Options){var parser=new Attr2Options;return{restrict:"E",require:"^map",link:function(scope,element,attrs,mapController){var filtered=new parser.filter(attrs);scope.google=google;var options=parser.getOptions(filtered,scope);options.pixelOffset&&(options.pixelOffset=google.maps.Size.apply(this,options.pixelOffset));var infoWindow=new google.maps.InfoWindow(options);infoWindow.contents=element.html();var events=parser.getEvents(scope,filtered);for(var eventName in events)eventName&&google.maps.event.addListener(infoWindow,eventName,events[eventName]);mapController.infoWindows.push(infoWindow),element.css({display:"none"}),scope.showInfoWindow=function(event,id,options){var infoWindow=scope.infoWindows[id],contents=infoWindow.contents,matches=contents.match(/\[\[[^\]]+\]\]/g);if(matches)for(var i=0,length=matches.length;length>i;i++){var expression=matches[i].replace(/\[\[/,"").replace(/\]\]/,"");try{contents=contents.replace(matches[i],eval(expression))}catch(e){expression="options."+expression,contents=contents.replace(matches[i],eval(expression))}}infoWindow.setContent(contents),infoWindow.open(scope.map,this)}}}}]),ngMap.directive("map",["Attr2Options","$parse","NavigatorGeolocation","GeoCoder","$compile",function(e,t,n,r){var o=new e;return{restrict:"AE",controller:["$scope",function(e){this.map=null,this.controls={},this.markers=[],this.shapes=[],this.infoWindows=[],this.markerCluster=null,this.initMap=function(e,t,i){var a=o.filter(i);e.google=google;var s=o.getOptions(a,e),p=o.getControlOptions(a);for(var c in p)c&&(s[c]=p[c]);var l=this,g=null;if(s.zoom||(s.zoom=15),s.center instanceof Array){var v=s.center[0],u=s.center[1];s.center=new google.maps.LatLng(v,u)}else g=s.center,delete s.center;for(var f in this.controls)f&&(s[f+"Control"]="false"===this.controls[f].enabled?0:1,delete this.controls[f].enabled,s[f+"ControlOptions"]=this.controls[f]);var m=document.createElement("div");m.style.width="100%",m.style.height="100%",t.prepend(m),l.map=new google.maps.Map(m,s),"string"==typeof g?r.geocode({address:g}).then(function(e){l.map.setCenter(e[0].geometry.location)}):s.center||n.getCurrentPosition().then(function(e){var t=e.coords.latitude,n=e.coords.longitude;l.map.setCenter(new google.maps.LatLng(t,n))});var d=o.getEvents(e,a);for(var h in d)h&&google.maps.event.addListener(l.map,h,d[h]);return e.map=l.map,l.map},this.addMarker=function(t){t.setMap(this.map),t.centered&&this.map.setCenter(t.position);var n=Object.keys(e.markers).length;e.markers[t.id||n]=t},this.initMarkers=function(){e.markers={};for(var t=0;t<this.markers.length;t++){var n=this.markers[t];this.addMarker(n)}return e.markers},this.initShapes=function(){e.shapes={};for(var t=0;t<this.shapes.length;t++){var n=this.shapes[t];n.setMap(this.map),e.shapes[n.id||t+1]=n}return e.shapes},this.initInfoWindows=function(){e.infoWindows={};for(var t=0;t<this.infoWindows.length;t++){var n=this.infoWindows[t];e.infoWindows[n.id||t+1]=n}return e.infoWindows},this.initMarkerClusterer=function(){return this.markerClusterer&&(e.markerClusterer=new MarkerClusterer(this.map,this.markerClusterer.data,this.markerClusterer.pptions)),e.markerClusterer}}],link:function(e,t,n,r){var o=r.initMap(e,t,n);e.$emit("mapInitialized",o);var i=r.initMarkers();e.$emit("markersInitialized",i);var a=r.initShapes();e.$emit("shapesInitialized",a);var s=r.initInfoWindows();e.$emit("infoWindowsInitialized",s);var p=r.initMarkerClusterer();e.$emit("markerClustererInitialized",p)}}}]),ngMap.directive("marker",["Attr2Options","GeoCoder","NavigatorGeolocation",function(e,t,n){var r=new e;return{restrict:"E",require:"^map",link:function(e,o,i,a){var s=new r.filter(i);e.google=google;var p=r.getOptions(s,e),c=r.getEvents(e,s),l=function(){var e=new google.maps.Marker(p);Object.keys(c).length>0;for(var t in c)t&&google.maps.event.addListener(e,t,c[t]);return e};if(p.position instanceof Array){var g=p.position[0],v=p.position[1];p.position=new google.maps.LatLng(g,v);var u=l();p.ngRepeat?a.addMarker(u):a.markers.push(u)}else if("string"==typeof p.position){var f=p.position;f.match(/^current/i)?n.getCurrentPosition().then(function(e){var t=e.coords.latitude,n=e.coords.longitude;p.position=new google.maps.LatLng(t,n);var r=l();a.addMarker(r)}):t.geocode({address:p.position}).then(function(e){var t=e[0].geometry.location;p.position=t;var n=l();a.addMarker(n)})}}}}]),ngMap.directive("markerClusterer",["Attr2Options",function(e){var t=new e;return{restrict:"E",require:"^map",link:function(e,n,r,o){var i=e.$eval(r.markers);delete r.markers;for(var a=new t.filter(r),s=[],p=0;p<i.length;p++){var c=i[p],l=c.position[0],g=c.position[1];c.position=new google.maps.LatLng(l,g);var v=new google.maps.Marker(c),u=t.getEvents(e,c);for(var f in u)f&&google.maps.event.addListener(v,f,u[f]);s.push(v)}o.markers=s,o.markerClusterer={data:s,options:a}}}}]),ngMap.directive("shape",["Attr2Options",function(e){var t=new e,n=function(e){return e[0]&&e[0]instanceof Array?e.map(function(e){return new google.maps.LatLng(e[0],e[1])}):new google.maps.LatLng(e[0],e[1])},r=function(e){var t=n(e);return new google.maps.LatLngBounds(t[0],t[1])},o=function(e,t){switch(e){case"circle":return t.center=n(t.center),new google.maps.Circle(t);case"polygon":return t.paths=n(t.paths),new google.maps.Polygon(t);case"polyline":return t.path=n(t.path),new google.maps.Polyline(t);case"rectangle":return t.bounds=r(t.bounds),new google.maps.Rectangle(t);case"groundOverlay":case"image":var o=t.url,i=r(t.bounds),a={opacity:t.opacity,clickable:t.clickable};return new google.maps.GroundOverlay(o,i,a)}return null};return{restrict:"E",require:"^map",link:function(e,n,r,i){var a=t.filter(r),s=a.name;delete a.name;var p=t.getOptions(a),c=o(s,p);c&&i.shapes.push(c);var l=t.getEvents(e,a);for(var g in l)l[g]&&google.maps.event.addListener(c,g,l[g])}}}]),ngMap.provider("Attr2Options",function(){this.$get=function(){return function(){this.filter=function(e){var t={};for(var n in e)n.match(/^\$/)||(t[n]=e[n]);return t},this.getOptions=function(attrs,scope){var options={};for(var key in attrs)if(attrs[key]){if(key.match(/^on[A-Z]/))continue;if(key.match(/ControlOptions$/))continue;var val=attrs[key];try{var num=Number(val);if(isNaN(num))throw"Not a number";options[key]=num}catch(err){try{options[key]=JSON.parse(val)}catch(err2){if(val.match(/^[A-Z][a-zA-Z0-9]+\(.*\)$/))try{var exp="new google.maps."+val;options[key]=eval(exp)}catch(e){options[key]=val}else if(val.match(/^[A-Z][a-zA-Z0-9]+\.[A-Z]+$/))try{options[key]=scope.$eval("google.maps."+val)}catch(e){options[key]=val}else if(val.match(/^[A-Z]+$/))try{var capitializedKey=key.charAt(0).toUpperCase()+key.slice(1);options[key]=scope.$eval("google.maps."+capitializedKey+"."+val)}catch(e){options[key]=val}else options[key]=val}}}return options},this.getEvents=function(e,t){var n={},r=function(e){return"_"+e.toLowerCase()},o=function(t){var n=t.match(/([^\(]+)\(([^\)]*)\)/),r=n[1],o=n[2].replace(/event[ ,]*/,""),i=e.$eval("["+o+"]");return function(t){e[r].apply(this,[t].concat(i))}};for(var i in t)if(t[i]){if(!i.match(/^on[A-Z]/))continue;var a=i.replace(/^on/,"");a=a.charAt(0).toLowerCase()+a.slice(1),a=a.replace(/([A-Z])/g,r);var s=t[i];n[a]=new o(s)}return n},this.getControlOptions=function(e){var t={};for(var n in e)if(e[n]){if(!n.match(/(.*)ControlOptions$/))continue;var r=e[n],o=r.replace(/'/g,'"');o=o.replace(/([^"]+)|("[^"]+")/g,function(e,t,n){return t?t.replace(/([a-zA-Z0-9]+?):/g,'"$1":'):n});try{var i=JSON.parse(o);for(var a in i)if(i[a]){var s=i[a];if("string"==typeof s?s=s.toUpperCase():"mapTypeIds"===a&&(s=s.map(function(e){return google.maps.MapTypeId[e.toUpperCase()]})),"style"===a){var p=n.charAt(0).toUpperCase()+n.slice(1),c=p.replace(/Options$/,"")+"Style";i[a]=google.maps[c][s]}else i[a]="position"===a?google.maps.ControlPosition[s]:s}t[n]=i}catch(l){}}return t}}}}),ngMap.service("GeoCoder",["$q",function(e){return{geocode:function(t){var n=e.defer(),r=new google.maps.Geocoder;return r.geocode(t,function(e,t){t==google.maps.GeocoderStatus.OK?n.resolve(e):n.reject("Geocoder failed due to: "+t)}),n.promise}}}]),ngMap.service("NavigatorGeolocation",["$q",function(e){return{getCurrentPosition:function(){var t=e.defer();return navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){t.resolve(e)},function(e){t.reject(e)}):t.reject("Browser Geolocation service failed."),t.promise},watchPosition:function(){return"TODO"},clearWatch:function(){return"TODO"}}}]);